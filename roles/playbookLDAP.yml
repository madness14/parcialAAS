- hosts: ldap
  become: true
  tasks:
    - name: actualizar repositorio apt
      apt:
        update_cache: yes

    - name: instalar samba ad dc
      apt:
        name: samba-ad-dc
        state: present

    - name: eliminar resolv.conf
      file:
        path: /etc/resolv.conf
        state: absent

    - name: crear resolv.conf nuevo
      copy:
        dest: /etc/resolv.conf
        content: |
          nameserver 127.0.0.1
          search patitohosting.licic

    - name: configurar /etc/hosts
      copy:
        dest: /etc/hosts
        content: |
          127.0.0.1 localhost
          192.168.56.105 ldap.patitohosting.licic ldap

    - name: eliminar smb.conf anterior
      file:
        path: /etc/samba/smb.conf
        state: absent

    - name: detener servicios smb viejos
      service:
        name: "{{ item }}"
        state: stopped
        enabled: no
      loop:
        - smbd
        - nmbd
        - winbind

    - name: borrar pids de samba
      file:
        path: /run/samba
        state: absent

    - name: provisionar dominio ad con samba
      command: samba-tool domain provision --realm=PATITOHOSTING.LICIC --domain=PATITOHOSTING --adminpass=AdminPass123 --server-role=dc --dns-backend=SAMBA_INTERNAL
      args:
        creates: /var/lib/samba/private/sam.ldb

    - name: ajustar permisos de secrets.tdb
      file:
        path: /var/lib/samba/private/secrets.tdb
        mode: '0600'

    - name: iniciar servicio samba-ad-dc
      service:
        name: samba-ad-dc
        state: started
        enabled: yes

    - name: instalar kerberos
      apt:
        name: 
          - krb5-user
          - libsasl2-modules-gssapi-mit
        state: present

    - name: crear archivo krb5.conf
      copy:
        dest: /etc/krb5.conf
        content: |
          [libdefaults]
              default_realm = PATITOHOSTING.LICIC
              dns_lookup_realm = false
              dns_lookup_kdc = true

          [realms]
              PATITOHOSTING.LICIC = {
                  kdc = ldap.patitohosting.licic
                  admin_server = ldap.patitohosting.licic
              }

          [domain_realm]
              .patitohosting.licic = PATITOHOSTING.LICIC
              patitohosting.licic = PATITOHOSTING.LICIC

    - name: crear usuario ldap 'ubuntu'
      command: samba-tool user create ubuntu 'Ubuntu#2024!'

    - name: agrega usuario 'ubuntu' a grupo 'users'
      command: samba-tool group addmembers users ubuntu

    - name: instalar herramientas ldap
      apt:
        name: ldap-utils
        state: present

    - name: esperar a que ldap est√© escuchando
      wait_for:
        port: 389
        delay: 5
        timeout: 60

    - name: prueba ldapsearch
      shell: ldapsearch -Y GSSAPI -H ldap://127.0.0.1 -b "dc=patitohosting,dc=licic" "(sAMAccountName=ubuntu)"
      register: ldapout

    - debug:
        var: ldapout.stdout_lines

